# Waitlist Notification Service - Implementation Guide

## Overview

The waitlist notification service provides comprehensive SMS/email notifications for patients and internal staff notifications for medical spa staff members. It handles the complete lifecycle of waitlist offers:

1. **Patient Confirmation** - When added to waitlist
2. **Offer Notifications** - When a slot becomes available
3. **Response Tracking** - Accept/decline with confirmation messages
4. **Expiration Handling** - When offers expire
5. **Periodic Reminders** - Check-in messages for patients still waiting
6. **Internal Staff Alerts** - Real-time notifications for staff about critical events

## Architecture

### File Structure

```
/src/services/waitlist/
  └── notifications.ts          # Main service implementation (24KB)

/src/app/api/waitlist/
  └── notify/
      └── route.ts               # POST/GET API endpoint (13KB)
```

### Core Components

#### 1. Notification Service (`notifications.ts`)

Provides functions to send all types of waitlist notifications:

- `notifyPatientAddedToWaitlist()` - Confirmation when patient joins waitlist
- `notifyOfferingAvailableSlot()` - Alert about available appointment
- `notifyOfferAccepted()` - Confirmation after patient accepts offer
- `notifyOfferDeclined()` - Acknowledgment of decline
- `notifyOfferExpired()` - Notification that offer expired
- `sendWaitlistReminder()` - Periodic reminder for patients waiting

#### 2. API Endpoint (`/api/waitlist/notify`)

RESTful endpoint supporting:
- **POST** requests for sending notifications
- **GET** requests for stats and health checks
- Query actions for debugging (entry history, staff log, stats)

## Usage Examples

### 1. Send Waitlist Confirmation

```javascript
const response = await fetch('/api/waitlist/notify', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    action: 'added',
    entryId: 'entry_123',
    patientId: 'patient_456',
    patientName: 'Sarah Johnson',
    patientPhone: '+1-555-0100',
    serviceName: 'Botox Injection',
    practitionerName: 'Dr. Smith' // optional
  })
});

const result = await response.json();
console.log(result);
// {
//   success: true,
//   action: 'added',
//   notification: {
//     type: 'sms',
//     messageId: 'SM1234567890abcdef',
//     sentAt: '2024-01-09T15:07:00.000Z'
//   },
//   message: 'added notification sent successfully'
// }
```

**Expected SMS:**
> Hi Sarah! You're now on our waitlist for Botox Injection with Dr. Smith. We'll text you when a slot opens up. Reply REMOVE anytime to opt out.

### 2. Notify Patient of Available Slot

```javascript
const offerToken = 'secure_token_abc123xyz'; // Generated by waitlist system

const response = await fetch('/api/waitlist/notify', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    action: 'offer',
    entryId: 'entry_123',
    patientId: 'patient_456',
    patientName: 'Sarah Johnson',
    patientPhone: '+1-555-0100',
    serviceName: 'Botox Injection',
    practitionerName: 'Dr. Smith',
    appointmentDate: '2024-01-15T10:00:00Z',
    appointmentTime: '10:00 AM',
    expiryMinutes: 30,
    offerToken: offerToken,
    appointmentId: 'apt_789' // optional
  })
});

const result = await response.json();
console.log(result);
// {
//   success: true,
//   action: 'offer',
//   notification: {
//     type: 'sms',
//     messageId: 'SM...',
//     offerToken: 'secure_token_abc123xyz',
//     offerLink: 'https://app.medspa.local/waitlist/offer/secure_token_abc123xyz'
//   }
// }
```

**Expected SMS:**
> Hi Sarah! Botox Injection slot open with Dr. Smith on Mon, Jan 15 at 10:00 AM. Reply YES to book or NO to skip. Expires in 30 min. Or tap: https://app.medspa.local/waitlist/offer/secure_token_abc123xyz

### 3. Confirm Offer Acceptance

```javascript
const response = await fetch('/api/waitlist/notify', {
  method: 'POST',
  body: JSON.stringify({
    action: 'accepted',
    entryId: 'entry_123',
    patientId: 'patient_456',
    patientName: 'Sarah Johnson',
    patientPhone: '+1-555-0100',
    serviceName: 'Botox Injection',
    appointmentDate: '2024-01-15T10:00:00Z',
    appointmentTime: '10:00 AM'
  })
});
```

**Expected SMS:**
> Confirmed! Sarah, your Botox Injection is booked for Mon, Jan 15 at 10:00 AM. You've been removed from the waitlist. Add to calendar: https://app.medspa.local/calendar/add

### 4. Send Periodic Reminder

```javascript
const daysWaiting = 7;

const response = await fetch('/api/waitlist/notify', {
  method: 'POST',
  body: JSON.stringify({
    action: 'reminder',
    entryId: 'entry_123',
    patientId: 'patient_456',
    patientName: 'Sarah Johnson',
    patientPhone: '+1-555-0100',
    serviceName: 'Botox Injection',
    daysWaiting: daysWaiting
  })
});
```

**Expected SMS:**
> Hi Sarah! You've been on our waitlist for Botox Injection for 7 days. We're working to find you a spot! Reply REMOVE to be taken off the list.

### 5. Query Notification History (Debugging)

```javascript
// Get all notifications for an entry
const response = await fetch('/api/waitlist/notify', {
  method: 'POST',
  body: JSON.stringify({
    action: 'query',
    queryType: 'entry_history',
    entryId: 'entry_123',
    limit: 10
  })
});

const { data } = await response.json();
console.log(data);
// {
//   entryId: 'entry_123',
//   notifications: [
//     { type: 'added', timestamp: '...', status: 'sent', ... },
//     { type: 'offer_sent', timestamp: '...', status: 'sent', ... },
//     { type: 'offer_accepted', timestamp: '...', status: 'sent', ... }
//   ],
//   total: 3
// }
```

### 6. Get Statistics

```javascript
// Get notification stats
const response = await fetch('/api/waitlist/notify?action=stats');
const { data } = await response.json();
console.log(data);
// {
//   totalNotifications: 245,
//   bySent: 240,
//   byFailed: 5,
//   byType: {
//     added: 50,
//     offer_sent: 80,
//     offer_accepted: 60,
//     offer_declined: 20,
//     offer_expired: 25,
//     reminder: 10
//   },
//   staffNotificationsCount: 42
// }
```

## Request Schema

### Common Fields (All Actions)

```typescript
{
  entryId: string          // Waitlist entry ID (required)
  patientId: string        // Patient ID (required)
  patientName: string      // Patient name (required)
  patientPhone: string     // Phone number, min 10 digits (required)
  patientEmail?: string    // Optional email for future multi-channel support
  serviceName: string      // Service name (required)
  practitionerName?: string // Practitioner name
  practitionerId?: string  // Practitioner ID
}
```

### Action-Specific Fields

#### `action: "added"`
No additional fields required.

#### `action: "offer"`
```typescript
{
  appointmentDate: string // ISO datetime (required)
  appointmentTime: string // HH:MM format (required)
  expiryMinutes: number   // 5-1440 min, default 30
  offerToken: string      // Secure token (required)
  appointmentId?: string  // Optional appointment ID
}
```

#### `action: "accepted"` | `action: "declined"` | `action: "expired"`
```typescript
{
  appointmentDate: string // ISO datetime
  appointmentTime: string // HH:MM format
}
```

#### `action: "reminder"`
```typescript
{
  daysWaiting: number // Days on waitlist (required)
}
```

#### `action: "query"`
```typescript
{
  queryType: 'entry_history' | 'staff_log' | 'stats'
  entryId?: string  // Required for entry_history
  limit?: number    // 1-100, default 50
}
```

## Response Format

### Success Response

```json
{
  "success": true,
  "action": "offer",
  "notification": {
    "type": "sms",
    "messageId": "SM1234567890abcdef",
    "sentAt": "2024-01-09T15:07:00.000Z",
    "recipientPhone": "+1-555-0100",
    "recipientEmail": "sarah@example.com",
    "offerToken": "secure_token_...",
    "offerLink": "https://app.medspa.local/waitlist/offer/..."
  },
  "message": "offer notification sent successfully"
}
```

### Error Response

```json
{
  "success": false,
  "error": "Rate limit exceeded",
  "code": "RATE_LIMIT_EXCEEDED"
}
```

## Rate Limiting

- **Per notification**: Max 10 notifications per minute for each entry
- **Per offer**: Max 3 offers per hour to same patient
- **Bulk operations**: Max 3 bulk notifications per hour (separate endpoint)

## SMS Templates

All SMS messages use predefined templates from `/src/lib/twilio.ts`:

| Action | Template | Character Count |
|--------|----------|-----------------|
| Added | `waitlistAdded` | ~140 chars |
| Offer | `waitlistSlotAvailable` | ~160 chars |
| Accepted | `waitlistOfferAccepted` | ~140 chars |
| Declined | `waitlistOfferDeclined` | ~120 chars |
| Expired | `waitlistOfferExpired` | ~120 chars |
| Reminder | `waitlistReminder` | ~130 chars |

## Internal Staff Notifications

Staff are notified about:

1. **Offer Sent** (High Priority)
   - Message: "An opening has been offered to Sarah Johnson for Botox Injection with Dr. Smith on Jan 15 at 10:00 AM. Offer expires in 30 minutes."

2. **Offer Acceptance** (High Priority)
   - Message: "Sarah Johnson has accepted the offer for Botox Injection on Jan 15 at 10:00 AM. Appointment is now confirmed."

3. **Offer Decline** (Medium Priority)
   - Message: "Sarah Johnson has declined the offer for Botox Injection. Offer should cascade to next eligible patient."

4. **Offer Expiration** (Low Priority)
   - Message: Auto-handled by system

## Notification Event Log

Each notification creates an event record with:

```typescript
{
  id: string               // Unique event ID (notif_timestamp_random)
  type: NotificationType   // 'added' | 'offer_sent' | 'offer_accepted' | ...
  entryId: string
  patientId: string
  patientName: string
  timestamp: Date
  channel: 'sms' | 'email' | 'internal'
  messageContent: string   // Full SMS/email text
  status: 'sent' | 'failed' | 'pending'
  metadata?: {
    serviceName: string
    appointmentDate: string
    offerToken: string
    twilioSid: string
    // ... other fields depending on notification type
  }
}
```

## Error Handling

The API handles and returns appropriate status codes:

- `200` - Success
- `400` - Validation error (invalid schema or missing fields)
- `429` - Rate limit exceeded
- `500` - Internal server error

All errors include a `code` field for programmatic handling:

```typescript
'VALIDATION_ERROR' | 'RATE_LIMIT_EXCEEDED' | 'INTERNAL_ERROR'
```

## Integration Points

### 1. In Waitlist Matching Engine

When an eligible patient is found:

```typescript
import { notifyOfferingAvailableSlot } from '@/services/waitlist/notifications'

const offer = await createWaitlistOffer(...)
const notificationResult = await notifyOfferingAvailableSlot({
  entryId: entry.id,
  patientId: entry.id,
  patientName: entry.name,
  patientPhone: entry.phone,
  serviceName: slot.serviceName,
  practitionerName: slot.practitionerName,
  appointmentDate: slot.date,
  appointmentTime: moment(slot.startTime).format('h:mm A'),
  expiryMinutes: settings.offerExpiryMinutes,
  offerToken: offer.offerToken
})
```

### 2. In Offer Response Handler

When patient responds via SMS or web:

```typescript
import { notifyOfferAccepted, notifyOfferDeclined } from '@/services/waitlist/notifications'

if (response === 'accept') {
  await notifyOfferAccepted({
    entryId: entry.id,
    patientId: entry.id,
    patientName: entry.name,
    patientPhone: entry.phone,
    serviceName: offer.appointmentSlot.serviceName,
    appointmentDate: offer.appointmentSlot.date,
    appointmentTime: moment(offer.appointmentSlot.startTime).format('h:mm A')
  })
} else {
  await notifyOfferDeclined({
    entryId: entry.id,
    patientId: entry.id,
    patientName: entry.name,
    patientPhone: entry.phone,
    serviceName: offer.appointmentSlot.serviceName
  })
}
```

### 3. In Cron Jobs

For periodic reminders:

```typescript
import { sendWaitlistReminder } from '@/services/waitlist/notifications'

// Run daily or weekly
const activeEntries = getActiveWaitlistEntries()
for (const entry of activeEntries) {
  const daysWaiting = moment().diff(moment(entry.waitingSince), 'days')
  if (daysWaiting > 0 && daysWaiting % 7 === 0) { // Every 7 days
    await sendWaitlistReminder({
      entryId: entry.id,
      patientId: entry.id,
      patientName: entry.name,
      patientPhone: entry.phone,
      serviceName: entry.requestedService,
      daysWaiting
    })
  }
}
```

## Database Schema (Future Implementation)

When migrating from in-memory storage to database:

```sql
-- Notification events table
CREATE TABLE notification_events (
  id VARCHAR(64) PRIMARY KEY,
  type VARCHAR(32) NOT NULL,
  entry_id VARCHAR(64) NOT NULL,
  patient_id VARCHAR(64) NOT NULL,
  patient_name VARCHAR(255) NOT NULL,
  timestamp TIMESTAMP NOT NULL,
  channel VARCHAR(20) NOT NULL, -- 'sms', 'email', 'internal'
  message_content TEXT NOT NULL,
  status VARCHAR(20) NOT NULL, -- 'sent', 'failed', 'pending'
  twilio_sid VARCHAR(64),
  metadata JSON,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX (entry_id),
  INDEX (patient_id),
  INDEX (timestamp)
);

-- Internal staff notifications table
CREATE TABLE staff_notifications (
  id VARCHAR(64) PRIMARY KEY,
  type VARCHAR(32) NOT NULL,
  title VARCHAR(255) NOT NULL,
  message TEXT NOT NULL,
  patient_name VARCHAR(255),
  service_name VARCHAR(255),
  priority VARCHAR(20) NOT NULL, -- 'low', 'medium', 'high'
  timestamp TIMESTAMP NOT NULL,
  read_by_staff JSON, -- { "staff_id": "timestamp" }
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX (timestamp),
  INDEX (priority)
);
```

## Testing

### Unit Testing

```typescript
import { notifyPatientAddedToWaitlist } from '@/services/waitlist/notifications'

describe('Waitlist Notifications', () => {
  it('should send added confirmation', async () => {
    const result = await notifyPatientAddedToWaitlist({
      entryId: 'entry_test_123',
      patientId: 'patient_123',
      patientName: 'Test Patient',
      patientPhone: '+1-555-0123',
      serviceName: 'Botox Injection'
    })

    expect(result.success).toBe(true)
    expect(result.type).toBe('sms')
    expect(result.messageId).toBeDefined()
  })
})
```

### API Testing

```bash
# Test added notification
curl -X POST http://localhost:3000/api/waitlist/notify \
  -H "Content-Type: application/json" \
  -d '{
    "action": "added",
    "entryId": "entry_test",
    "patientId": "patient_123",
    "patientName": "Test Patient",
    "patientPhone": "+1-555-0123",
    "serviceName": "Botox Injection"
  }'

# Check stats
curl http://localhost:3000/api/waitlist/notify?action=stats
```

## Troubleshooting

### Common Issues

**SMS not sending:**
- Check Twilio credentials in `.env.local`
- Verify phone number is E.164 format (+1-555-0100)
- Check rate limits

**Rate limit errors:**
- Max 10 notifications per minute per entry
- Max 3 offers per hour to same patient
- Wait for rate limit window to reset

**Missing notifications:**
- Check notification history: `POST /api/waitlist/notify` with `queryType: 'entry_history'`
- Review SMS templates in `/src/lib/twilio.ts`
- Check Twilio logs in Twilio Dashboard

## Performance Considerations

- **Notification storage**: Currently in-memory, scales to ~1000 notifications per app instance
- **Rate limiting**: In-memory maps, consider Redis for distributed systems
- **SMS sending**: Async via Twilio API (fire-and-forget)
- **Compliance logging**: Every SMS is logged for HIPAA audit trail

## Future Enhancements

1. Email notifications (currently SMS only)
2. Push notifications to mobile app
3. Webhook callbacks for SMS delivery status
4. A/B testing different message templates
5. Scheduled/delayed notifications
6. Multi-language support
7. Rich media (images) in SMS
8. WhatsApp/Telegram as notification channels

## Security

- All offer tokens are cryptographically secure (32 bytes of entropy)
- Phone numbers are masked in logs for privacy
- SMS content complies with HIPAA requirements
- Rate limiting prevents abuse
- Request validation via Zod schemas

## Support & Debugging

### Enable Debug Logging

```typescript
// In development environment
if (process.env.NODE_ENV === 'development') {
  console.log('[Waitlist Notification] Debug info...')
}
```

### View Notification History

```javascript
// Get notification events for a specific entry
const response = await fetch('/api/waitlist/notify', {
  method: 'POST',
  body: JSON.stringify({
    action: 'query',
    queryType: 'entry_history',
    entryId: 'entry_123',
    limit: 50
  })
})
```

## Related Documentation

- [Waitlist Management System](/Users/daminirijhwani/medical-spa-platform/apps/admin/src/lib/waitlist.ts)
- [SMS Templates and Twilio Integration](/Users/daminirijhwani/medical-spa-platform/apps/admin/src/lib/twilio.ts)
- [Bulk Notification Endpoint](/Users/daminirijhwani/medical-spa-platform/apps/admin/src/app/api/waitlist/bulk-notify/route.ts)
