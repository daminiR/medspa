// ===================
// INVENTORY MANAGEMENT MODELS
// ===================
// Add these models to schema.prisma to enable inventory migration

model Product {
  id                String   @id @default(uuid())
  name              String
  sku               String?  @unique
  category          String
  subcategory       String?
  manufacturer      String?
  manufacturerId    String?

  // Injectable-specific
  isInjectable      Boolean  @default(false)
  unitsPerPackage   Int?
  unitType          String   // units, syringe, vial, ml, etc.

  // Reconstitution
  reconstitutionRequired Boolean @default(false)
  maxHoursAfterReconstitution Int?
  defaultDilution   Float?

  // Pricing
  costPrice         Float
  retailPrice       Float
  markup            Float?

  // Stock management
  reorderPoint      Int      @default(0)
  reorderQuantity   Int      @default(0)

  // Status
  isActive          Boolean  @default(true)
  requiresLotTracking Boolean @default(false)
  requiresSerialTracking Boolean @default(false)
  requiresRefrigeration Boolean @default(false)

  // Metadata
  description       String?
  notes             String?
  tags              String[]

  // Audit
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String
  lastModifiedBy    String

  // Relations
  lots              InventoryLot[]
  transactions      InventoryTransaction[]
  alerts            InventoryAlert[]
  openVials         OpenVialSession[]

  @@index([category])
  @@index([isActive])
  @@index([sku])
}

model InventoryLot {
  id                String   @id @default(uuid())
  productId         String
  product           Product  @relation(fields: [productId], references: [id])

  // Lot identification
  lotNumber         String
  batchNumber       String?
  serialNumber      String?

  // Dates
  manufacturingDate DateTime?
  expirationDate    DateTime
  receivedDate      DateTime @default(now())
  openedDate        DateTime?

  // Quantities
  initialQuantity   Float
  currentQuantity   Float
  reservedQuantity  Float    @default(0)
  unitType          String

  // Reconstitution
  reconstitutionDetails Json?

  // Location
  locationId        String
  location          Location @relation(fields: [locationId], references: [id])
  storageLocation   String?

  // Purchase info
  purchaseOrderId   String?
  vendorId          String?
  vendorName        String?
  purchaseCost      Float

  // Status
  status            LotStatus @default(available)
  qualityNotes      String?

  // Recall tracking
  recallStatus      Json?

  // Audit
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String
  lastUpdatedBy     String

  // Relations
  transactions      InventoryTransaction[]
  openVials         OpenVialSession[]
  wasteRecords      WasteRecord[]

  @@index([productId])
  @@index([lotNumber])
  @@index([expirationDate])
  @@index([locationId])
  @@index([status])
}

model InventoryAlert {
  id                String        @id @default(uuid())
  type              AlertType
  severity          AlertSeverity
  status            AlertStatus   @default(active)

  // Related entities
  productId         String?
  product           Product?      @relation(fields: [productId], references: [id])
  productName       String?
  lotId             String?
  lotNumber         String?
  locationId        String
  locationName      String

  // Alert content
  title             String
  message           String
  actionRequired    String?

  // Thresholds
  currentValue      Float?
  thresholdValue    Float?
  expirationDate    DateTime?
  daysUntilExpiration Int?

  // Acknowledgment
  acknowledgedBy    String?
  acknowledgedAt    DateTime?
  resolvedBy        String?
  resolvedAt        DateTime?
  resolution        String?

  // Notifications
  notificationSent  Boolean       @default(false)

  // Audit
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([type])
  @@index([severity])
  @@index([status])
  @@index([locationId])
  @@index([productId])
}

model OpenVialSession {
  id                String   @id @default(uuid())

  // Lot reference
  lotId             String
  lot               InventoryLot @relation(fields: [lotId], references: [id])
  lotNumber         String

  // Product reference
  productId         String
  product           Product  @relation(fields: [productId], references: [id])
  productName       String

  // Vial info
  vialNumber        Int
  originalUnits     Float
  currentUnits      Float
  usedUnits         Float    @default(0)
  wastedUnits       Float    @default(0)

  // Reconstitution
  reconstitutedAt   DateTime?
  reconstitutedBy   String?
  reconstitutedByName String?
  diluentType       String?
  diluentVolume     Float?
  concentration     String?

  // Stability tracking
  expiresAt         DateTime
  stabilityHoursTotal Int
  stabilityHoursRemaining Int
  isExpired         Boolean  @default(false)

  // Location
  locationId        String
  locationName      String
  storageLocation   String?

  // Status
  status            VialStatus @default(active)
  closedAt          DateTime?
  closedBy          String?
  closedReason      VialClosedReason?

  // Financial tracking
  vialCost          Float
  costPerUnitUsed   Float
  revenueGenerated  Float    @default(0)
  profitMargin      Float    @default(0)

  // Audit
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String
  lastUpdatedBy     String

  // Relations
  usageRecords      VialUsageRecord[]

  @@index([lotId])
  @@index([productId])
  @@index([locationId])
  @@index([status])
  @@index([expiresAt])
}

model VialUsageRecord {
  id                String   @id @default(uuid())
  vialSessionId     String
  vialSession       OpenVialSession @relation(fields: [vialSessionId], references: [id], onDelete: Cascade)

  timestamp         DateTime @default(now())
  patientId         String
  patientName       String
  appointmentId     String
  practitionerId    String
  practitionerName  String
  unitsUsed         Float
  areasInjected     Json?
  chartId           String?
  notes             String?

  @@index([vialSessionId])
  @@index([patientId])
  @@index([practitionerId])
  @@index([timestamp])
}

model InventoryTransaction {
  id                String   @id @default(uuid())
  type              TransactionType
  status            TransactionStatus @default(completed)
  timestamp         DateTime @default(now())

  // Product/Lot
  productId         String
  product           Product  @relation(fields: [productId], references: [id])
  productName       String
  lotId             String
  lot               InventoryLot @relation(fields: [lotId], references: [id])
  lotNumber         String

  // Quantity
  quantity          Float
  unitType          String
  quantityBefore    Float
  quantityAfter     Float

  // Cost
  unitCost          Float
  totalCost         Float

  // Location
  locationId        String
  locationName      String

  // Related entities
  appointmentId     String?
  patientId         String?
  patientName       String?
  practitionerId    String?
  practitionerName  String?
  invoiceId         String?
  invoiceLineItemId String?
  purchaseOrderId   String?
  transferId        String?

  // Treatment details
  treatmentDetails  Json?

  // Reason & notes
  reason            String
  notes             String?

  // Approval
  performedBy       String
  performedByName   String
  approvedBy        String?
  approvedByName    String?
  approvalRequired  Boolean  @default(false)
  approvalTimestamp DateTime?

  // Metadata
  metadata          Json?

  // Audit
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([timestamp])
  @@index([productId])
  @@index([lotId])
  @@index([locationId])
  @@index([patientId])
  @@index([practitionerId])
}

model WasteRecord {
  id                String   @id @default(uuid())

  // Lot reference
  lotId             String
  lot               InventoryLot @relation(fields: [lotId], references: [id])
  lotNumber         String

  // Product reference
  productId         String
  productName       String

  // Vial session (if applicable)
  openVialSessionId String?

  // Waste details
  unitsWasted       Float
  unitType          String
  reason            WasteReason
  reasonNotes       String?

  // Cost
  unitCost          Float
  totalWasteValue   Float

  // Who/when
  recordedBy        String
  recordedByName    String
  recordedAt        DateTime @default(now())

  // Location
  locationId        String
  locationName      String

  // Related entities
  practitionerId    String?
  practitionerName  String?
  appointmentId     String?

  // Audit
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([lotId])
  @@index([reason])
  @@index([recordedAt])
  @@index([locationId])
  @@index([practitionerId])
}

model InventoryTransfer {
  id                String   @id @default(uuid())
  transferNumber    String   @unique

  // Locations
  sourceLocationId  String
  sourceLocationName String
  destinationLocationId String
  destinationLocationName String

  // Items (stored as JSON for flexibility)
  items             Json

  // Dates
  requestedDate     DateTime @default(now())
  approvedDate      DateTime?
  shippedDate       DateTime?
  receivedDate      DateTime?

  // Status
  status            TransferStatus @default(draft)

  // Shipping
  trackingNumber    String?
  carrier           String?

  // Value
  totalValue        Float

  // People
  requestedBy       String
  requestedByName   String
  approvedBy        String?
  approvedByName    String?
  shippedBy         String?
  shippedByName     String?
  receivedBy        String?
  receivedByName    String?

  // Notes
  requestNotes      String?
  approvalNotes     String?
  receivingNotes    String?

  // Audit
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([transferNumber])
  @@index([status])
  @@index([sourceLocationId])
  @@index([destinationLocationId])
  @@index([requestedDate])
}

model InventoryCount {
  id                String   @id @default(uuid())
  countNumber       String   @unique

  // Location
  locationId        String
  locationName      String

  // Type & filters
  countType         CountType
  categoryFilter    String?
  productFilter     String[]

  // Dates
  scheduledDate     DateTime
  startedAt         DateTime?
  completedAt       DateTime?
  approvedAt        DateTime?
  postedAt          DateTime?

  // Items (stored as JSON)
  items             Json

  // Metrics
  totalItems        Int      @default(0)
  countedItems      Int      @default(0)
  itemsWithVariance Int      @default(0)
  totalVarianceValue Float   @default(0)

  // Status
  status            CountStatus @default(draft)

  // People
  createdBy         String
  startedBy         String?
  completedBy       String?
  approvedBy        String?
  postedBy          String?

  // Notes
  notes             String?

  // Audit
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([countNumber])
  @@index([status])
  @@index([locationId])
  @@index([scheduledDate])
}

// ===================
// INVENTORY ENUMS
// ===================

enum LotStatus {
  available
  quarantine
  expired
  recalled
  depleted
  damaged
}

enum AlertType {
  low_stock
  out_of_stock
  expiring_soon
  expired
  recall
  temperature_excursion
  variance_detected
  reorder_recommended
}

enum AlertSeverity {
  info
  warning
  critical
}

enum AlertStatus {
  active
  acknowledged
  resolved
  dismissed
}

enum VialStatus {
  active
  expired
  depleted
  discarded
}

enum VialClosedReason {
  depleted
  expired
  stability_exceeded
  contamination
  manual_close
}

enum TransactionType {
  receive
  adjustment_add
  adjustment_remove
  treatment_use
  transfer_out
  transfer_in
  damage
  expiration
  recall
  return_vendor
  sale
  waste
  reconstitution
}

enum TransactionStatus {
  pending
  completed
  cancelled
  reversed
}

enum WasteReason {
  expired_unused
  stability_exceeded
  contamination
  draw_up_loss
  patient_no_show
  adverse_reaction_discard
  training
  damaged
  recall
  other
}

enum TransferStatus {
  draft
  requested
  approved
  in_transit
  received
  cancelled
}

enum CountType {
  full
  cycle
  spot
  category
}

enum CountStatus {
  draft
  in_progress
  completed
  approved
  posted
}
