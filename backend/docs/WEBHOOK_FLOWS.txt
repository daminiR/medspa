MESSAGING WEBHOOKS - FLOW DIAGRAMS
===================================

FLOW 1: INBOUND SMS - OPT-OUT
------------------------------
Patient sends "STOP"
    â†“
Twilio â†’ POST /api/webhooks/twilio/inbound
    â†“
Parse form data (MessageSid, From, To, Body)
    â†“
Validate Twilio signature (skip in dev)
    â†“
Find patient by phone (+11234567890)
    â†“
Detect opt-out keyword: "STOP" âœ“
    â†“
Process opt-out:
  - patient.smsConsent = false
  - patient.smsOptOutAt = new Date()
    â†“
Send auto-reply:
  "You've been unsubscribed from Luxe Medical Spa.
   Reply START to resubscribe."
    â†“
Store inbound message:
  {
    messageSid: "SM123",
    from: "+11234567890",
    body: "STOP",
    isOptOut: true,
    processed: true
  }
    â†“
Return 200 OK
    â†“
âœ… Patient opted out successfully


FLOW 2: INBOUND SMS - EMERGENCY
--------------------------------
Patient sends "Severe pain and swelling"
    â†“
Twilio â†’ POST /api/webhooks/twilio/inbound
    â†“
Parse form data
    â†“
Validate signature
    â†“
Find/create patient
    â†“
Detect emergency keywords: ["SEVERE PAIN"] âœ“
    â†“
Create staff alert:
  {
    type: "emergency",
    patientPhone: "+11234567890",
    message: "Severe pain and swelling",
    triggerKeywords: ["SEVERE PAIN"],
    createdAt: NOW
  }
    â†“
Log alert: ğŸš¨ EMERGENCY ALERT CREATED
    â†“
Send auto-reply:
  "We received your message. If this is a medical
   emergency, please call 911 immediately. Our staff
   will contact you shortly."
    â†“
Find/create conversation
    â†“
Store inbound message:
  {
    messageSid: "SM456",
    body: "Severe pain and swelling",
    isEmergency: true,
    conversationId: "conv-123",
    processed: false
  }
    â†“
Update conversation:
  - messageCount++
  - unreadCount++
  - lastMessageAt = NOW
    â†“
Return 200 OK
    â†“
âœ… Emergency alert created, staff notified


FLOW 3: INBOUND SMS - SIMPLE COMMAND
-------------------------------------
Patient sends "C"
    â†“
Twilio â†’ POST /api/webhooks/twilio/inbound
    â†“
Parse form data
    â†“
Validate signature
    â†“
Find patient
    â†“
Check opt-out keywords â†’ none
Check opt-in keywords â†’ none
Check emergency keywords â†’ none
    â†“
Detect simple command: "C" â†’ "confirm" âœ“
    â†“
Find/create conversation
    â†“
Store inbound message:
  {
    messageSid: "SM789",
    body: "C",
    detectedCommand: "confirm",
    conversationId: "conv-123"
  }
    â†“
Update conversation
    â†“
Return 200 OK
    â†“
âœ… Command detected, ready for processing


FLOW 4: STATUS UPDATE - DELIVERED
----------------------------------
Twilio sends delivery status
    â†“
Twilio â†’ POST /api/webhooks/twilio/status
    â†“
Parse form data:
  {
    MessageSid: "SM123",
    MessageStatus: "delivered",
    To: "+11234567890"
  }
    â†“
Validate signature
    â†“
Store status update:
  {
    messageSid: "SM123",
    messageStatus: "delivered",
    timestamp: NOW
  }
    â†“
Find outbound message by MessageSid
    â†“
Update message:
  - status = "delivered"
  - deliveredAt = NOW
    â†“
Return 200 OK
    â†“
âœ… Message marked as delivered


FLOW 5: STATUS UPDATE - ERROR 30004 (BLOCKED)
----------------------------------------------
Twilio sends error status
    â†“
Twilio â†’ POST /api/webhooks/twilio/status
    â†“
Parse form data:
  {
    MessageSid: "SM999",
    MessageStatus: "failed",
    ErrorCode: "30004",
    ErrorMessage: "Message blocked",
    To: "+11234567890"
  }
    â†“
Validate signature
    â†“
Store status update
    â†“
Find outbound message
    â†“
Update message:
  - status = "failed"
  - errorCode = "30004"
  - errorMessage = "Message blocked"
    â†“
Detect error code 30004 â†’ Carrier blocking
    â†“
Find patient by phone
    â†“
Process carrier-level opt-out:
  - patient.smsConsent = false
  - patient.smsOptOutAt = NOW
    â†“
Log: "Message blocked by carrier (30004)"
    â†“
Return 200 OK
    â†“
âš ï¸ Patient automatically opted out due to carrier block


FLOW 6: STATUS UPDATE - ERROR 30006 (LANDLINE)
-----------------------------------------------
Twilio sends error status
    â†“
Twilio â†’ POST /api/webhooks/twilio/status
    â†“
Parse form data:
  {
    MessageSid: "SM888",
    MessageStatus: "failed",
    ErrorCode: "30006",
    ErrorMessage: "Landline or unreachable carrier",
    To: "+11234567890"
  }
    â†“
Process error code 30006 â†’ Landline detected
    â†“
Find patient
    â†“
Update patient:
  - phoneType = "landline"
  - phoneValid = false
    â†“
Log: "Landline detected (30006)"
    â†“
Return 200 OK
    â†“
âš ï¸ Phone marked as landline, SMS disabled


FLOW 7: STATUS UPDATE - ERROR 30007 (SPAM)
-------------------------------------------
Twilio sends spam filter status
    â†“
Twilio â†’ POST /api/webhooks/twilio/status
    â†“
Parse form data:
  {
    MessageSid: "SM777",
    MessageStatus: "failed",
    ErrorCode: "30007",
    ErrorMessage: "Message filtered as spam"
  }
    â†“
Process error code 30007 â†’ Spam filter
    â†“
Find outbound message
    â†“
Create staff alert:
  {
    type: "emergency",
    message: "Message filtered as spam: [message text]",
    triggerKeywords: ["SPAM_FILTER"]
  }
    â†“
Log: ğŸš¨ "Message marked as spam (30007)"
    â†“
Return 200 OK
    â†“
âš ï¸ Staff alerted to review message content


DATA FLOW: COMPLETE CONVERSATION
---------------------------------

1. Staff sends appointment reminder:
   â†“
   System â†’ Twilio API:
     POST https://api.twilio.com/messages
     {
       from: "+10987654321",
       to: "+11234567890",
       body: "Reminder: Botox tomorrow at 2pm"
     }
   â†“
   Twilio returns: { sid: "SM123" }
   â†“
   Store in outboundMessages:
     {
       externalSid: "SM123",
       status: "queued",
       sentAt: NOW
     }

2. Twilio delivers message:
   â†“
   Twilio â†’ POST /api/webhooks/twilio/status
   { MessageSid: "SM123", MessageStatus: "delivered" }
   â†“
   Update outboundMessages: status = "delivered"

3. Patient replies "C" (confirm):
   â†“
   Twilio â†’ POST /api/webhooks/twilio/inbound
   { From: "+11234567890", Body: "C" }
   â†“
   Detect command: "confirm"
   â†“
   Find conversation or create new one
   â†“
   Store inbound message
   â†“
   Update conversation counts

4. Staff replies "Great! See you tomorrow":
   â†“
   System â†’ Twilio API
   â†“
   Store outbound message

5. Later, patient cancels with "R":
   â†“
   Twilio â†’ POST /api/webhooks/twilio/inbound
   â†“
   Detect command: "reschedule"
   â†“
   Staff notified in conversation thread


SECURITY FLOW: SIGNATURE VALIDATION
------------------------------------

Twilio sends webhook:
  POST /api/webhooks/twilio/inbound
  Headers:
    X-Twilio-Signature: "abc123..."
  Body:
    MessageSid=SM123&From=+1...&Body=Hello
    â†“
Backend receives request
    â†“
Extract signature from header
    â†“
Build full URL:
  protocol: x-forwarded-proto || "http"
  host: header("host")
  path: req.path
  â†’ "https://api.example.com/api/webhooks/twilio/inbound"
    â†“
Parse form data â†’ params object
    â†“
Check if TWILIO_AUTH_TOKEN is set
    â†“
YES: Validate signature
  â†“
  import twilio from 'twilio';
  const isValid = twilio.validateRequest(
    authToken,
    signature,
    url,
    params
  );
  â†“
  If invalid:
    - Log error
    - Return 200 OK (prevent retries)
    - Stop processing
  â†“
  If valid: Continue processing

NO: Skip validation (dev mode)
  â†“
  Log: "Development mode - no validation"
  â†“
  Continue processing


ERROR HANDLING FLOW
--------------------

Any error occurs during processing:
    â†“
Try-catch block catches error
    â†“
Log error to console:
  console.error("Error processing webhook:", error)
    â†“
ALWAYS return 200 OK:
  return c.text('', 200)
    â†“
Why?
  - Prevents Twilio retrying
  - Twilio thinks webhook succeeded
  - Errors are logged for debugging
  - No patient data exposed


DEVELOPMENT MODE FLOW
----------------------

TWILIO_AUTH_TOKEN not set
    â†“
Webhook receives request
    â†“
Skip signature validation
    â†“
Process normally
    â†“
When sending SMS:
    â†“
sendSMS() checks config
    â†“
No Twilio credentials?
    â†“
Console output instead:
  === SMS Response (Development Mode) ===
  To: +11234567890
  Body: You've been unsubscribed...
  ======================================
    â†“
Continue processing
    â†“
Return 200 OK


TESTING FLOW: DEBUG ENDPOINTS
------------------------------

Developer wants to check recent messages:
    â†“
GET /api/webhooks/twilio/inbound-messages
    â†“
Query inboundMessages map
    â†“
Sort by timestamp DESC
    â†“
Return last 50 messages:
  {
    messages: [
      {
        id: "msg-1",
        from: "+11234567890",
        body: "STOP",
        isOptOut: true,
        timestamp: "2024-12-20T15:30:00Z"
      },
      ...
    ],
    total: 156
  }


Developer checks for emergencies:
    â†“
GET /api/webhooks/twilio/alerts
    â†“
Query staffAlerts map
    â†“
Sort by createdAt DESC
    â†“
Return alerts:
  {
    alerts: [
      {
        type: "emergency",
        patientPhone: "+11234567890",
        message: "Severe pain...",
        triggerKeywords: ["SEVERE PAIN"],
        acknowledgedAt: null
      },
      ...
    ],
    total: 3
  }


INTEGRATION FLOW: WITH MAIN API
--------------------------------

Main app startup:
    â†“
src/index.ts imports routes
    â†“
import messagingWebhooks from './routes/messaging-webhooks';
    â†“
Mount on main app:
api.route('/webhooks', messagingWebhooks);
    â†“
Server starts on port 8080
    â†“
Endpoints available:
  - GET  /api/webhooks/twilio/health
  - POST /api/webhooks/twilio/inbound
  - POST /api/webhooks/twilio/status
  - GET  /api/webhooks/twilio/inbound-messages
  - GET  /api/webhooks/twilio/status-updates
  - GET  /api/webhooks/twilio/alerts
  - GET  /api/webhooks/twilio/conversations


Twilio configured:
  Phone Number: +10987654321
  Messaging Configuration:
    - Inbound URL: https://api.example.com/api/webhooks/twilio/inbound
    - Status URL:  https://api.example.com/api/webhooks/twilio/status
    â†“
Patient sends text
    â†“
Twilio receives
    â†“
Twilio POSTs to inbound URL
    â†“
Webhook processes
    â†“
Response sent to patient
    â†“
Twilio POSTs delivery status
    â†“
Status webhook updates message
    â†“
Complete!


KEYWORD PRIORITY FLOW
----------------------

Message received: "STOP EMERGENCY"
    â†“
Check opt-out first (highest priority)
    â†“
Contains "STOP" â†’ OPT-OUT âœ“
    â†“
Process opt-out immediately
    â†“
Send confirmation
    â†“
Return 200 OK
    â†“
Emergency keywords ignored (patient opted out)


Message received: "START YES"
    â†“
Check opt-out â†’ none
    â†“
Check opt-in
    â†“
Contains "START" â†’ OPT-IN âœ“
    â†“
Process opt-in immediately
    â†“
Send confirmation
    â†“
Return 200 OK
    â†“
"YES" command ignored (opt-in takes priority)


Message received: "911 need help"
    â†“
Check opt-out â†’ none
Check opt-in â†’ none
    â†“
Check emergency keywords
    â†“
Contains "911" â†’ EMERGENCY âœ“
    â†“
Create staff alert
    â†“
Send auto-reply
    â†“
Store in conversation
    â†“
Return 200 OK


Message received: "C"
    â†“
Check opt-out â†’ none
Check opt-in â†’ none
Check emergency â†’ none
    â†“
Check simple commands
    â†“
Matches "C" â†’ CONFIRM âœ“
    â†“
Store with detectedCommand = "confirm"
    â†“
Return 200 OK


Message received: "Hello, when is my appointment?"
    â†“
Check all keywords â†’ none match
    â†“
Store as regular conversation message
    â†“
Return 200 OK
    â†“
Staff sees in unread messages
